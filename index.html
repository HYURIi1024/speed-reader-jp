<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>速読支援アプリ</title>
  <script src="kuromoji.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    #display {
      font-size: 2em;
      margin: 30px;
      height: 2em;
      color: #000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>日本語速読支援アプリ</h1>
  <textarea id="inputText" rows="5" cols="50" placeholder="日本語の文章をペーストしてください"></textarea><br>
  <button onclick="start()">表示開始</button>

  <div id="display"></div>

  <script>
    let tokenizer = null;
    let tokens = [];
    let index = 0;
    let timer = null;

    // kuromoji.js 初期化
    window.onload = () => {
      kuromoji.builder({ dicPath: "./dict/" }).build((err, _tokenizer) => {
        if (err) {
          console.error("辞書読み込み失敗:", err);
          return;
        }
        tokenizer = _tokenizer;
        console.log("辞書読み込み成功");
      });
    };

    function start() {
      const text = document.getElementById("inputText").value;
      if (!tokenizer) {
        alert("辞書がまだ読み込まれていません。もう少し待ってください。");
        return;
      }

      const tokensRaw = tokenizer.tokenize(text);
      tokens = combineBunsetsu(tokensRaw);
      index = 0;
      clearInterval(timer);
      updateDisplay();
      timer = setInterval(updateDisplay, 500);
    }

    function updateDisplay() {
      const curr = tokens[index] || '';
      document.getElementById("display").textContent = curr;
      index++;
      if (index >= tokens.length) {
        clearInterval(timer);
      }
    }

    function combineBunsetsu(tokensRaw) {
  const units = [];
  const specialAux = ['ます', 'です', 'た', 'だ', 'ぬ', 'ん'];
  let currentUnit = '';
  let i = 0;

  while (i < tokensRaw.length) {
    const token = tokensRaw[i];
    const next = tokensRaw[i + 1];
    const next2 = tokensRaw[i + 2];
    const next3 = tokensRaw[i + 3];
    const surface = token.surface_form;


        //マスの後ろに句読点
        if (
  token.pos === '助動詞' &&
  specialAux.includes(token.surface_form) &&
  token.conjugated_form === '基本形' &&
  next &&
  (next.surface_form === '。' || next.surface_form === '、')
) {
  currentUnit += token.surface_form + next.surface_form;
  units.push(currentUnit);
  currentUnit = '';
  i += 2;
  continue;
}


    // --- ユニット条件⑱：助動詞(体言接続)→名詞(非自立)→助動詞(特殊/基本形)→助詞(接続助詞)
    if (
      token.pos === '助動詞' &&
      token.conjugated_form === '体言接続' &&
      next && next.pos === '名詞' && next.pos_detail_1 === '非自立' &&
      next2 && next2.pos === '助動詞' &&
      specialAux.includes(next2.surface_form) &&
      next2.conjugated_form === '基本形' &&
      next3 && next3.pos === '助詞' && next3.pos_detail_1 === '接続助詞'
    ) {
      currentUnit += surface + next.surface_form + next2.surface_form + next3.surface_form;
      units.push(currentUnit);
      currentUnit = '';
      i += 4;
      continue;
    }

    // --- ユニット条件⑲：名詞（一般）→助詞（係助詞）
    if (
      token.pos === '名詞' &&
      token.pos_detail_1 === '一般' &&
      next && next.pos === '助詞' &&
      next.pos_detail_1 === '係助詞'
    ) {
      currentUnit += surface + next.surface_form;
      units.push(currentUnit);
      currentUnit = '';
      i += 2;
      continue;
    }

    // --- ユニット条件⑳：終助詞＋句読点
    if (
      token.pos === '助詞' &&
      token.pos_detail_1 === '終助詞' &&
      next && (next.surface_form === '。' || next.surface_form === '、')
    ) {
      currentUnit += surface + next.surface_form;
      units.push(currentUnit);
      currentUnit = '';
      i += 2;
      continue;
    }


    // --- ユニット条件⑰：助動詞特殊型（体言接続以外）＋句読点
    if (
      token.pos === '助動詞' &&
      specialAux.includes(surface) &&
      token.conjugated_form !== '体言接続'
    ) {
      currentUnit += surface;
      if (next && (next.surface_form === '。' || next.surface_form === '、')) {
        currentUnit += next.surface_form;
        i++;
      }
      units.push(currentUnit);
      currentUnit = '';
      i++;
      continue;
    }

    // --- ユニット条件⑭：助詞＋句読点
    if (
      token.pos === '助詞' &&
      next && (next.surface_form === '。' || next.surface_form === '、')
    ) {
      currentUnit += surface + next.surface_form;
      units.push(currentUnit);
      currentUnit = '';
      i += 2;
      continue;
    }

    // --- ユニット条件⑮：動詞＋助動詞
    if (
      token.pos === '動詞' &&
      next && next.pos === '助動詞'
    ) {
      currentUnit += surface + next.surface_form;
      units.push(currentUnit);
      currentUnit = '';
      i += 2;
      continue;
    }

    // --- 通常処理：句読点が来たらそれも含めてユニットとして切る（優先度低）
if (
  next &&
  (next.surface_form === '。' || next.surface_form === '、')
) {
  currentUnit += surface + next.surface_form;
  units.push(currentUnit);
  currentUnit = '';
  i += 2;
  continue;
}


    // --- ユニット条件⑬：同じ品詞が連続する場合、次が異なるまで連結
    let currentPos = token.pos;
    currentUnit += surface;
    while (
      i + 1 < tokensRaw.length &&
      tokensRaw[i + 1].pos === currentPos
    ) {
      i++;
      currentUnit += tokensRaw[i].surface_form;
    }

    units.push(currentUnit);
    currentUnit = '';
    i++;
  }

  if (currentUnit) {
    units.push(currentUnit);
  }

  return mergeShortUnits(units);
}



function mergeShortUnits(units) {
  const merged = [];
  let i = 0;
  while (i < units.length) {
    const current = units[i];
    const next = units[i + 1];
    if (current.length <= 4 && next && (current.length + next.length) < 12) {
      merged.push(current + next);
      i += 2;
    } else {
      merged.push(current);
      i++;
    }
  }
  return merged;
}


  </script>
</body>
</html>