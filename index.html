<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>速読支援アプリ</title>
  <script src="kuromoji.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    #display {
      font-size: 2em;
      margin: 30px;
      height: 2em;
      color: #000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>日本語速読支援アプリ</h1>
  <textarea id="inputText" rows="5" cols="50" placeholder="日本語の文章をペーストしてください"></textarea><br>
  <button onclick="start()">表示開始</button>

  <div id="display"></div>

  <script>
    let tokenizer = null;
    let tokens = [];
    let index = 0;
    let timer = null;

    // kuromoji.js 初期化
    window.onload = () => {
      kuromoji.builder({ dicPath: "./dict/" }).build((err, _tokenizer) => {
        if (err) {
          console.error("辞書読み込み失敗:", err);
          return;
        }
        tokenizer = _tokenizer;
        console.log("辞書読み込み成功");
      });
    };

    function start() {
      const text = document.getElementById("inputText").value;
      if (!tokenizer) {
        alert("辞書がまだ読み込まれていません。もう少し待ってください。");
        return;
      }

      const tokensRaw = tokenizer.tokenize(text);
      tokens = combineBunsetsu(tokensRaw);
      index = 0;
      clearInterval(timer);
      updateDisplay();
      timer = setInterval(updateDisplay, 500);
    }

    function updateDisplay() {
      const curr = tokens[index] || '';
      document.getElementById("display").textContent = curr;
      index++;
      if (index >= tokens.length) {
        clearInterval(timer);
      }
    }

    function combineBunsetsu(tokensRaw) {
  const units = [];
  const specialAux = ['ます', 'です', 'た', 'だ', 'ぬ', 'ん'];
  let currentUnit = '';
  let i = 0;

  while (i < tokensRaw.length) {
    const token = tokensRaw[i];
    const surface = token.surface_form;
    const pos = token.pos;
    const next = tokensRaw[i + 1];

// --- 助動詞語幹の次に副詞化が来る場合、その語までまとめてユニット化 ---
if (
  token.pos === '名詞' &&
  token.pos_detail_1 === '非自立' &&
  token.pos_detail_2 === '助動詞語幹' &&
  next &&
  next.pos_detail_1 === '副詞化'
) {
  currentUnit += surface + next.surface_form;
  units.push(currentUnit);
  currentUnit = '';
  i += 2;
  continue;
}
// --- 助動詞の次に終助詞が来る場合、その助動詞＋終助詞までをまとめてユニット化 ---
if (
  token.pos === '助動詞' &&
  next &&
  next.pos_detail_1 === '終助詞'
) {
  currentUnit += surface + next.surface_form;
  units.push(currentUnit);
  currentUnit = '';
  i += 2;
  continue;
}
// --- 終助詞が現れたら、その語を含めてユニットを確定 ---
if (token.pos_detail_1 === '終助詞') {
  currentUnit += surface;
  units.push(currentUnit);
  currentUnit = '';
  i++;
  continue;
}

    // --- 名詞・非自立・助動詞語幹が現れたら、その語までを1ユニットとする ---
if (
  token.pos === '名詞' &&
  token.pos_detail_1 === '非自立' &&
  token.pos_detail_2 === '助動詞語幹'
) {
  currentUnit += surface;
  units.push(currentUnit);
  currentUnit = '';
  i++;
  continue;
}
    // --- 接続詞＋句読点 ---
    if (pos === '接続詞') {
      if (currentUnit) {
        units.push(currentUnit);
        currentUnit = '';
      }
      if (next && (next.surface_form === '。' || next.surface_form === '、')) {
        units.push(surface + next.surface_form);
        i += 2;
        continue;
      } else {
        units.push(surface);
        i++;
        continue;
      }
    }

    // --- 助動詞特殊型が現れたら、それまでをユニットとして切る（句読点が後にあれば含める） ---
if (pos === '助動詞' && specialAux.includes(surface)) {
  currentUnit += surface;

  if (next && (next.surface_form === '。' || next.surface_form === '、')) {
    currentUnit += next.surface_form;
    i++; // 句読点もスキップ
  }

  units.push(currentUnit);
  currentUnit = '';
  i++;
  continue;
}
    // --- 助動詞特殊型が現れたら、それまでをユニットとして切る ---
    if (pos === '助動詞' && specialAux.includes(surface)) {
      currentUnit += surface;
      units.push(currentUnit);
      currentUnit = '';
      i++;
      continue;
    }

    // --- 同じ品詞が連続 ---
    currentUnit += surface;
    while (
      i + 1 < tokensRaw.length &&
      tokensRaw[i + 1].pos === pos &&
      tokensRaw[i + 1].surface_form !== '。' &&
      tokensRaw[i + 1].surface_form !== '、'
    ) {
      i++;
      currentUnit += tokensRaw[i].surface_form;
    }

    // --- 句読点ならユニット確定 ---
    if (surface === '。' || surface === '、') {
      units.push(currentUnit);
      currentUnit = '';
    }
    

    i++;
  }

  if (currentUnit) {
    units.push(currentUnit);
  }

  return units;
}
  </script>
</body>
</html>